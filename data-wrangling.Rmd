---
title: "Data-Wrangling"
author: "Ziji Zhou and Rohil Bathija"
date: "October 14, 2021"
urlcolor: blue
linkcolor: blue
output:
  pdf_document:
# DO NOT CHANGE YAML BELOW THIS LINE    
    number_sections: yes
  # html_document:
  #   toc: yes
  #   toc_float: yes
classoption: fleqn
subparagraph: yes
header-includes:
  # LaTeX packages
  - \usepackage{fancyhdr,titling}\usepackage[compact]{titlesec}
  - \AtBeginEnvironment{quote}{\sffamily}
  # Question format (e.g., `Problem 3`)
  - > 
    \titleformat{\section}[hang]{\ifnum \value{section}>0 \newpage
                                  \else \vspace{14pt} \fi
                                  \sffamily\large}
                                  {\hspace*{-9mm}Problem \thesection}{4mm}{}[]
  # Subquestion format (e.g., `3.1`)
  - >
    \titleformat{\subsection}[hang]{\vspace{14pt}\sffamily\large}
                                    {\hspace*{-9mm}\thesubsection}{4mm}{}[\vspace*{11pt}]
  # Page layout
  - >
    \pagestyle{fancy}\fancyhf{}
    \renewcommand{\headrulewidth}{0pt}
    \cfoot{\sffamily\thepage}
  # Header layout
  - >
    \lhead{\hspace*{-9mm}\sffamily\footnotesize 
            \copyright Brittney E. Bailey | STAT 231 | Lab}
  # Title layout
  - \pretitle{\hspace*{-9mm}\sffamily\footnotesize
              \copyright Brittney E. Bailey | STAT 231 | Lab
              \par \Large\bfseries \hspace*{-9mm}}
  - \posttitle{\\\hspace*{-9mm}\rule{7in}{2pt}}
  - \preauthor{\begin{flushright} \large} \postauthor{\end{flushright}}
  - \predate{\begin{flushright}\sffamily\footnotesize}
  - \postdate{\end{flushright}\vspace*{-33pt}}
  - \setlength{\droptitle}{-1in}
  # First page
  - >
    \AtBeginDocument{\sffamily\raggedright}
---

```{r setup, include = FALSE}
# load packages
library(tidyverse) 
library(kableExtra)
library(robotstxt) 
library(rvest)

# set code chunk defaults
knitr::opts_chunk$set(tidy = F, # display code as typed
                      size = "small", # slightly smaller code font
                      message = FALSE,
                      warning = FALSE,
                      comment = "\t") 

# set black & white default plot theme
theme_set(theme_classic()) 

# improve digit and NA display 
options(scipen = 1, knitr.kable.NA = '')
```

# **NBA Dataset** {-}

Get the payroll of each team for a certain year range.

things we need:
total payroll of team by year
total team wins for the year
https://www.basketball-reference.com/
each teams zipcode DONE
any data about zipcode DONE
highest paid players: DONE
http://www.espn.com/nba/salaries/_/year/2020/seasontype/1
stats for those players.

## **Historical Salaries** {-}

### **Workflow** {-}

Seasons -> teams -> player salaries.
Seasons url: https://www.basketball-reference.com/leagues/

```{r}
# check paths
nba_url <- "https://www.basketball-reference.com/leagues/"

paths_allowed(nba_url)
```


```{r}
# Team historical win% and total salary

# get table 

nba_data <- nba_url %>% 
  read_html() %>%
  html_nodes("table") %>%
  purrr::pluck(1) %>%
  html_table() %>%
  janitor::clean_names() %>%
  # filter years wanted
  filter(str_detect(x,"^20|199")) %>%
  filter(!str_detect(x,"^2021")) %>%
  # rename
  rename(season = x) %>%
  # add link column and delete extra columns
  select("season") %>%
  mutate(link_bref = "") 

# manual urls per season
rows = 1
years = 2021:1991
for(i in years){
  nba_data$link_bref[rows] = paste("https://www.basketball-reference.com/leagues/NBA_",i,".html",sep = "") 
  rows = rows + 1
}

# add link for each team on each season
for(i in nba_data$link_bref){
  # set url
  url <- i
  
  # get the team names as a vector
  team_name <- url %>%
    read_html() %>%
    html_elements("#per_game-team > tbody > tr > td.left > a") %>%
    html_text()
  
  # get the links of each team
  team_link <- url %>%
    read_html() %>%
    html_elements("#per_game-team > tbody > tr > td.left > a") %>%
    html_attr("href")
  
  # adjust the links
  for(x in 1:length(team_link)){
    team_link[x] <- paste("https://www.basketball-reference.com",team_link[x],sep = "")
  }
  
  # get win % for each team
  for(x in team_link){
    team_stats <- x %>%
      read_html() %>%
      html_elements("#team_misc") %>%
      html_table()
  }
  
}

team_link <- "https://www.basketball-reference.com/teams/PHI/1991.html"

team_stats <- team_link %>%
      read_html() %>%
      html_elements("#salaries2 > tbody > tr:nth-child(1) > td.left > a")

team_stats
```

```{r}
# nba city and median income

# convert the excel zip codes into csv for zip code info

library(readxl)

nba_zip_codes <- read_excel("data/nba-zip-codes.xlsm")

zipcode_income <- read_excel("data/zipcodeavgsal.xlsm")


# tidy and join data

zipcode_income <- zipcode_income %>% 
  janitor::clean_names() %>%
  rename(zip = zip_codes)

nba_zip_codes <- nba_zip_codes %>%
  janitor::clean_names()

nba_city_income <- nba_zip_codes %>%
  inner_join(zipcode_income, by = c("zip" = "zip"))

write.csv(nba_city_income, "data/nba_city_income.csv")
```

```{r}
#NBA top player salary

# from basketball reference
nba_salary <- read_excel("data/nba_salary.xlsm")
write.csv(nba_salary, "data/nba_salary.csv")
```

```{r}
# getting a table of the top paid players in the nba.
paid_url <- "https://hoopshype.com/salaries/players/"
paths_allowed(paid_url)
paid_players <- paid_url %>%
  read_html() %>%
  html_nodes("table")%>%
  purrr::pluck(1)%>%
  html_table() %>%
  janitor::clean_names()%>%
  #removing first redunadnt column
  select(!"x1") %>%
  #remove first row which had titles
  filter(!str_detect(x2,"Player")) %>%
  #creating new names for columns
  rename( Player = x2, Salary = x3) %>%
  #only need the first two rows (player and salary)
  select(c("Player", "Salary"))
  #renaming the columns

paid_players

write_csv(paid_players, "data/paid_players.csv")
```